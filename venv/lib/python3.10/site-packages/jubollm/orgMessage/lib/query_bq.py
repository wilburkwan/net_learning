import requests
import pandas as pd
import json

from linkinpark.lib.common.bq_manager import BigQueryConnector


CONN = BigQueryConnector()


def query_org_data():
    query = f"""
            SELECT  
                a._id, 
                a.stoolType, 
                a.medicineNote, 
                a.individualActivityNote,
                b.OrgMessage
            FROM
                jubo-ai.raw_prod_datahub_mongo.carediaryv2 AS a 
            LEFT JOIN
                jubo-ai.raw_prod_datahub_mongo.communicationbooks AS b
            ON
                a._id = b._id
            WHERE
                a.individualActivityNote IS NOT NULL 
                AND a.stoolType IS NOT NULL
                AND a.medicineNote IS NOT NULL
                AND b.OrgMessage IS NOT NULL
        """
    df_query, _ = CONN.execute_sql_in_bq(query)

    return df_query


def query_data(num):
    query = f"""
        SELECT
            stoolType,
            medicineNote
        FROM 
            jubo-ai.raw_prod_datahub_mongo.carediaryv2
        WHERE
            individualActivityNote IS NOT NULL
            AND stoolType IS NOT NULL
            AND medicineNote IS NOT NULL
    """
    df_query, _ = CONN.execute_sql_in_bq(query)

    # get headers
    data_header = df_query.columns
    patient_data = df_query.iloc[num, :]

    # use data_header and patient_data to create a dictionary with json format
    patient_data = patient_data.to_dict()

    return json.dumps(patient_data, ensure_ascii=False)
